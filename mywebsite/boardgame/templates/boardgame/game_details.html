{% extends 'boardgame/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-2 text-center">
            {% if game.thumbnail_file %}
            <img src="{{ game.thumbnail_file.url }}" alt="{{ game.name }} Thumbnail" class="img-fluid rounded mb-3"
                style="max-width: 300px; height: auto;">
            {% else %}
            <img src="{% static 'boardgame/images/default_thumbnail.jpg' %}" alt="Default Thumbnail"
                class="img-fluid rounded mb-3" style="max-width: 200px; height: auto;">
            {% endif %}
        </div>
        <div class="col-md-8">
            <h1>{{ game.name }}</h1>
            <br>
            {% if user.is_authenticated %}
            <form method="post" action="">
                {% csrf_token %}
                {% if is_signed_up %}
                <button type="submit" class="btn btn-secondary btn-sm" name="leave">Leave Game</button>
                {% else %}
                {% if remaining_slots > 0 and is_attending %}
                <button type="submit" class="btn btn-primary btn-sm" name="sign_up">Sign up</button>
                {% else %}
                {% if is_attending %}
                <button type="button" class="btn btn-secondary btn-sm" disabled>Waitlist</button>
                {% endif %}
                {% endif %}
                {% endif %}
            </form>
            {% else %}
            <p>You must <a href="{% url 'login' %}">login</a> first to sign up for the game.</p>
            {% endif %}
            <br>
            <p><b>Players:</b> {{ game.min_players }} - {{ game.max_players }}</p>
            <p><b>Difficulty:</b> {{ game.weight }} / 5</p>
            <p><b>Remaining Sign-up Slots:</b> {{ remaining_slots }}</p>
            <p><b>Description:</b></p>
            {% if game.description|length > 100 %}
            <div id="description-container">
                <p id="short-description">{{ game.description|slice:":100"|safe }}</p>
                <p id="full-description" style="display:none;">{{ game.description|safe }}</p>
                <a href="#" onclick="toggleDescription()" id="readMoreBtn">...See more</a>
            </div>
            {% else %}
            <p>{{ game.description|safe }}</p>
            {% endif %}
        </div>
    </div>
    <br />
    <hr>
    <div class="row">
        <div class="col-md-12">
            <h4>Players Attending</h4>
            {% if game_signup_set.exists %}
            <ul class="list-group">
                {% for signup in game_signup_set %}
                <li class="list-group-item">{{ signup.user.username }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p>No players have signed up yet.</p>
            {% endif %}
        </div>
    </div>
    <hr>
    <h2>Comments...</h2>
    {% if user.is_authenticated %}
    <div class="row mt-4">
        <div class="col-md-12">
            <form method="post" action="" id="comment-form" style="display: none;">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea class="form-control" id="comment-content" name="comment_content" rows="3"
                        placeholder="Add a comment..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm" name="comment" id="submit-comment-btn"
                    disabled>Comment</button>
                <button type="button" class="btn btn-secondary btn-sm" id="cancel-comment-btn">Cancel</button>
            </form>
            <div id="add-comment-line" class="form-control">Add a comment...</div>
        </div>
    </div>
    {% else %}
    <p>You must <a href="{% url 'login' %}">login</a> first to add a comment.</p>
    {% endif %}
    <br />
    {% if not game.comments.all %}
    No comments yet
    {% else %}
    {% for comment in game.comments.all %}
    <strong>
        {{ comment.user }} -
        {{ comment.date_added }}
    </strong>
    <br />
    {{ comment.content }}
    <br /><br />
    {% endfor %}
    {% endif %}
    <hr>
    <div class="row mt-4">
        <div class="col-md-12">
            <a href="{% url 'event_details' event.id %}" class="btn btn-secondary btn-sm">Back to Event</a>
            <a href="{% url 'home' %}" class="btn btn-secondary btn-sm">Back to Home</a>
        </div>
    </div>
</div>

<script>
    function toggleDescription() {
        var shortDescription = document.getElementById("short-description");
        var fullDescription = document.getElementById("full-description");
        var readMoreBtn = document.getElementById("readMoreBtn");

        if (fullDescription.style.display === "none") {
            fullDescription.style.display = "block";
            shortDescription.style.display = "none";
            readMoreBtn.innerHTML = "See less";
        } else {
            fullDescription.style.display = "none";
            shortDescription.style.display = "block";
            readMoreBtn.innerHTML = "...See more";
        }
    }

    document.getElementById("add-comment-line").addEventListener("click", function () {
        this.style.display = "none";
        document.getElementById("comment-form").style.display = "block";
    });

    document.getElementById("cancel-comment-btn").addEventListener("click", function () {
        document.getElementById("comment-content").value = "";
        document.getElementById("submit-comment-btn").disabled = true;
        document.getElementById("comment-form").style.display = "none";
        document.getElementById("add-comment-line").style.display = "block";
    });

    document.getElementById("comment-content").addEventListener("input", function () {
        document.getElementById("submit-comment-btn").disabled = this.value.trim() === "";
    });
</script>

{% endblock %}